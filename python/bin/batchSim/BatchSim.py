#!/usr/bin/python
'''
\author Thomas Watteyne <watteyne@eecs.berkeley.edu>    
\author Xavier Vilajosana <xvilajosana@eecs.berkeley.edu>
\author Kazushi Muraoka <k-muraoka@eecs.berkeley.edu>
\author Nicola Accettura <nicola.accettura@eecs.berkeley.edu>
'''

#============================ adjust path =====================================

import os
import sys
if __name__=='__main__':
    here = sys.path[0]
    sys.path.insert(0, os.path.join(here, '..', '..'))

#============================ logging =========================================

import logging
class NullHandler(logging.Handler):
    def emit(self, record):
        pass
log = logging.getLogger('BatchSim')
log.setLevel(logging.ERROR)
log.addHandler(NullHandler())

#============================ imports =========================================

import time
import numpy
import itertools
import logging.config

from argparse      import ArgumentParser
from SimEngine     import SimEngine,   \
                          SimSettings, \
                          Propagation
from SimGui        import SimGui

#============================ defines =========================================

#============================ main ============================================

def parseCliOptions():
    
    parser = ArgumentParser()
    
    parser.add_argument( '--numMotesList',
        dest       = 'numMotesList',
        nargs      = '+',
        type       = int,
        default    = [20, 40],
        help       = 'List of network sizes, in number of simulated motes.',
    )
    
    parser.add_argument( '--pkPeriodList',
        dest       = 'pkPeriodList',
        nargs      = '+',
        type       = float,
        default    = [1.0, 2.0],
        help       = 'List of average periods (is s) between two packets generated by a mote.',
    )
    
    parser.add_argument( '--pkPeriodVarList',
        dest       = 'pkPeriodVarList',
        nargs      = '+',
        type       = float,
        default    = [0.1, 0.2],
        help       = 'List of variability percentages of the traffic, in [0..1[ (use 0 for CBR).',
    )
    
    parser.add_argument( '--otfThresholdList',
        dest       = 'otfThresholdList',
        nargs      = '+',
        type       = int,
        default    = [0, 10],
        help       = 'List of OTF thresholds, in cells.',
    )
    
    parser.add_argument( '--numRuns',
        dest       = 'numRuns',
        type       = int,
        default    = 5, 
        help       = 'Number of simulation runs per each configurations.',
    )
    
    opts           = parser.parse_args()
    numRuns=opts.__dict__.pop('numRuns')
    
    return numRuns, opts

def postprocessing(filename, postprocessingFilename, numRuns, cycles):
    f=open(filename)
    lines=f.readlines()
    f.close()
    while lines[0].startswith('#'):
        lines.pop(0)
    assert len(lines)==numRuns*cycles
    matrixResults=numpy.array([[[float(l) for l in lines.pop(0).strip().split('\t')[2:]] for i in xrange(cycles)] for run in xrange(numRuns)])
    # change matrixResults here for further analysis 
    sumValues=numpy.sum(matrixResults, axis=0)
    sumSquareValues=numpy.sum(matrixResults**2, axis=0)
    f=open(postprocessingFilename, 'w')
    f.write('# SUM VALUES\n')
    for line in sumValues:
        formatString='\t'.join(['{{{0}:>5}}'.format(i) for i in xrange(len(line))])
        f.write(formatString.format(*tuple(line))+'\n')
    f.write('# SUM SQUARE VALUES\n')
    for line in sumSquareValues:
        formatString='\t'.join(['{{{0}:>5}}'.format(i) for i in xrange(len(line))])
        f.write(formatString.format(*tuple(line))+'\n')
    f.close()
    
def main():
    # initialize logging
    logging.config.fileConfig('logging.conf')
    
    # parse CLI options
    numRuns, options   = parseCliOptions()
    print options
    
    for numMotes in options.numMotesList:
        for pkPeriod in options.pkPeriodList:
            for pkPeriodVar in options.pkPeriodVarList:
                for otfThreshold in options.otfThresholdList:
                    directory = os.path.join('results', \
                        'numMotes_{0}_pkPeriod_{1}_pkPeriodVar_{2}_otfThreshold_{3}'.format(numMotes,pkPeriod,pkPeriodVar,otfThreshold))
                    if not os.path.exists(directory):
                        os.makedirs(directory)
                    idfilename='{0}_{1}'.format(int(time.time()), os.getpid())
                    filename=directory+'//output_{0}.dat'.format(idfilename)
                    while os.path.isfile(filename):
                        print 'ok'
                    settings = SimSettings.SimSettings(\
                                numMotes=numMotes, \
                                pkPeriod=pkPeriod, \
                                pkPeriodVar=pkPeriodVar, \
                                otfThreshold=otfThreshold, \
                                outputFile=filename, \
                                numCyclesPerRun=20
                                )
                    # run the simulation runs
                    for runNum in xrange(numRuns):
                        
                        # logging
                        print('run {0}, start'.format(runNum))
                        
                        # create singletons
                        propagation     = Propagation.Propagation()
                        simengine       = SimEngine.SimEngine(runNum) # start simulation
                        
                        # wait for simulation to end
                        simengine.join()
                        
                        # destroy singletons
                        simengine.destroy()
                        propagation.destroy()
                        
                        # logging
                        print('run {0}, end'.format(runNum))
                    
                    postprocessingFilename=directory+'//postprocessing_{0}_{1}.dat'.format(idfilename, numRuns)
                    postprocessing(filename, postprocessingFilename, numRuns, settings.numCyclesPerRun)
                    settings.destroy()                       # destroy the SimSettings singleton

if __name__=="__main__":
    main()

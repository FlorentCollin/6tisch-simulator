#!/usr/bin/python
'''
\author Thomas Watteyne <watteyne@eecs.berkeley.edu>    
\author Xavier Vilajosana <xvilajosana@eecs.berkeley.edu>
\author Kazushi Muraoka <k-muraoka@eecs.berkeley.edu>
\author Nicola Accettura <nicola.accettura@eecs.berkeley.edu>
'''

#============================ adjust path =====================================

import os
import sys
if __name__=='__main__':
    here = sys.path[0]
    sys.path.insert(0, os.path.join(here, '..', '..'))

#============================ logging =========================================

import logging
class NullHandler(logging.Handler):
    def emit(self, record):
        pass
log = logging.getLogger('SimpleSim')
log.setLevel(logging.ERROR)
log.addHandler(NullHandler())

#============================ imports =========================================

import logging.config

from optparse      import OptionParser
from SimEngine     import SimEngine,   \
                          SimSettings, \
                          Propagation
from SimGui        import SimGui

#============================ defines =========================================

#============================ main ============================================

def parseCliOptions():
    
    parser = OptionParser()
    
    parser.add_option( '--squareSide',
        dest       = 'squareSide',
        type       = 'float', 
        help       = 'Length of the side of the square area the motes are deployed in, in km.',
    )
    
    parser.add_option( '--numMotes',
        dest       = 'numMotes',
        type       = 'int',
        help       = 'Number of simulated motes.',
    )
    
    parser.add_option( '--numChans',
        dest       = 'numChans',
        type       = 'int',
        help       = 'Number of frequency channels (between 1 and 16).',
    )
    
    parser.add_option( '--slotDuration',
        dest       = 'slotDuration',
        type       = 'float',
        help       = 'Duration of a TSCH timeslot, in seconds.',
    )
    
    parser.add_option( '--slotframeLength',
        dest       = 'slotframeLength',
        type       = 'int',
        help       = 'Number of timeslots in a slotframe.',
    )
    
    parser.add_option( '--pkPeriod',
        dest       = 'pkPeriod',
        type       = 'float',
        help       = 'Average period (is s) between two packets generated by a mote.',
    )
    
    parser.add_option( '--pkPeriodVar',
        dest       = 'pkPeriodVar',
        type       = 'float',
        help       = 'Variability of the traffic, in [0..1[ (use 0 for CBR).',
    )
    
    parser.add_option( '--otfThreshold',
        dest       = 'otfThreshold',
        type       = 'int',
        help       = 'OTF threshhold, in cells.',
    )
    
    parser.add_option( '--numCyclesPerRun',
        dest       = 'numCyclesPerRun',
        type       = 'int',
        help       = 'Duration of one simulation run, in slotframe cycle.',
    )
    
    parser.add_option( '--numRuns',
        dest       = 'numRuns',
        type       = 'int',
        default    = 3, 
        help       = 'Number of simulation runs.',
    )
    
    parser.add_option( '--gui',
        dest       = 'gui',
        action     = 'store_true',
        default    = False, 
        help       = 'Display the GUI during execution.',
    )
    
    (opts, args)   = parser.parse_args()
    numRuns=opts.__dict__.pop('numRuns')
    guiFlag=opts.__dict__.pop('gui')
    for opt in opts.__dict__.keys():
        if opts.__dict__[opt]==None:
            opts.__dict__.pop(opt)
    return numRuns, guiFlag, opts.__dict__

def main():
    
    # initialize logging
    logging.config.fileConfig('logging.conf')
    
    # parse CLI options
    numRuns, guiFlag, options   = parseCliOptions()
    
    # start the GUI
    if guiFlag:
        gui                 = SimGui.SimGui()
    
    # run the simulation runs
    for runNum in xrange(numRuns):
        
        # logging
        print('run {0}, start'.format(runNum))
        
        # create singletons
        settings        = SimSettings.SimSettings(**options)
        propagation     = Propagation.Propagation()
        simengine       = SimEngine.SimEngine(runNum) # start simulation
        
        # wait for simulation to end
        simengine.join()
        
        # destroy singletons
        simengine.destroy()
        propagation.destroy()
        settings.destroy()                       # destroy the SimSettings singleton
        
        # logging
        print('run {0}, end'.format(runNum))

if __name__=="__main__":
    main()
